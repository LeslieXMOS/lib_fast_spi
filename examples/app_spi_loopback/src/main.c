#include <stdio.h>
#include <string.h>
#include <xs1.h>
#include <platform.h>
#include <xcore/parallel.h>
#include <xcore/select.h>
#include <xcore/channel.h>
#include <xcore/port.h>
#include <xcore/clock.h>
#include <xcore/triggerable.h>
#include <xcore/interrupt_wrappers.h>
#include <xcore/interrupt.h>
#include <xclib.h>
#include "fast_spi.h"

const uint8_t __attribute__((aligned (4))) test_data[640] = {
    0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
    0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
    0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
    0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
    0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
    0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
    0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
    0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
    0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
    0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
    0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
    0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
    0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
    0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
    0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
    0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
    0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
    0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
    0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
    0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
    0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
    0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
    0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
    0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
    0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
    0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
    0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
    0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
    0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
    0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
    0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
    0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
    0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
    0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
    0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
    0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
    0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
    0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
    0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
    0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
    0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
    0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
    0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
    0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
    0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
    0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
    0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
    0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
    0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
    0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
    0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
    0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
    0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
    0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
    0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
    0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
    0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
    0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
    0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
    0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
    0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
    0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
    0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
    0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
    0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
    0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
    0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
    0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
    0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
    0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
    0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
    0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
    0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
    0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
    0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
    0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
    0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
    0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
    0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
    0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D
};

bool check_data_same(const uint8_t* a, const uint8_t* b, size_t* len) {
    for (int i = 0; i < *len; ++i) {
        if (a[i] != b[i]) {
            *len = i;
            return false;
        }
    }
    return true;
}

DECLARE_JOB(spi_master_task, (fast_spi_master_handle_t*, fast_spi_master_device_handle_t*));
void spi_master_task(fast_spi_master_handle_t* spi_ctx, fast_spi_master_device_handle_t* spi_master_dev) {
    uint8_t __attribute__((aligned (4))) tx_buf[4+NUM_NOP+640];
    uint8_t __attribute__((aligned (4))) rx_buf[4+NUM_NOP+640];
    bool check_pass;
    size_t check_fail_idx;

    local_thread_mode_set_bits(thread_mode_high_priority);

    fast_spi_master_init_xfer(spi_master_dev);

    while (1) {
        for (int j = 0; j < 50; ++j) {
            fast_spi_master_set_clk_div(spi_master_dev, j);
            fast_spi_master_init_xfer(spi_master_dev);
            for (int i = 1; i <= 640; ++i) {
                for (int k = 0; k < i; ++k) {
                    // set reg data
                    memset(rx_buf, 0, sizeof(rx_buf));
                    memset(tx_buf, 0, sizeof(tx_buf));
                    tx_buf[0] = 0x03;           // WR_DATA
                    tx_buf[1] = k & 0xFF;       // Address
                    tx_buf[2] = (k>>8) & 0xFF;
                    tx_buf[3] = (k>>16) & 0xFF;
                    memcpy(&tx_buf[4+NUM_NOP], test_data, i-k);
                    fast_spi_master_xfer(spi_master_dev, tx_buf, rx_buf, 4+NUM_NOP+(i-k));
                    // printf("s%d\n",4+NUM_NOP+(i-k));
                    // delay_microseconds(100);
                    // read reg data
                    memset(rx_buf, 0, sizeof(rx_buf));
                    // memset(tx_buf, 0, sizeof(tx_buf));
                    tx_buf[0] = 0x04;           // RD_DATA
                    tx_buf[1] = k & 0xFF;       // Address
                    tx_buf[2] = (k>>8) & 0xFF;
                    tx_buf[3] = (k>>16) & 0xFF;
                    fast_spi_master_xfer(spi_master_dev, tx_buf, rx_buf, 4+NUM_NOP+(i-k));
                    check_fail_idx = i-k;
                    check_pass = check_data_same(&rx_buf[4+NUM_NOP], test_data, &check_fail_idx);
                    if (check_pass == false) {
                        printf("Data not match, clk div: %d, xfer addr: 0x%x, xfer len: %d, expected: 0x%x, recv: 0x%x\n",
                            j, k, i-k, test_data[check_fail_idx], rx_buf[4+NUM_NOP+check_fail_idx]
                        );
                        while (1) {
                            
                        }
                    }
                    // for (int idx = 0; idx < 4+NUM_NOP+(i-k)+5; ++idx) {
                    //     printf("%X ", tx_buf[idx]);
                    // }
                    // printf("\n");
                }
            }
            printf("Passed, clk div: %d\n", j);
        }
    }
}

void main_tile0(chanend_t c_tile1, unsigned tile1_id)
{
    // spi master
    port_t p_m_sclk  = PORT_SQI_SCLK_0; // SPI CLK
    port_t p_m_cs    = XS1_PORT_4B;     // QSPI_D0
    port_t p_m_miso  = PORT_SPI_MISO;   // MISO
    port_t p_m_mosi  = PORT_SPI_MOSI;   // MOSI
    // clock block
    xclock_t clk0    = XS1_CLKBLK_1;

    port_t p_s_sclk  = PORT_SQI_CS_0;   // QSPI CS_N
    port_t p_s_ss    = PORT_SSB;        // SPI_CS_N
    port_t p_s_miso  = PORT_I2C_SDA;    // SDA
    port_t p_s_mosi  = PORT_I2C_SCL;    // SCL
    xclock_t clk1    = XS1_CLKBLK_2;

    fast_spi_master_handle_t spi_ctx;
    fast_spi_master_device_handle_t spi_dev;
    fast_spi_master_init(&spi_ctx, p_m_sclk, p_m_miso, p_m_mosi, p_m_cs, clk0, true);
    fast_spi_master_device_init(&spi_ctx, &spi_dev, 0, 0, 0, fast_spi_clock_source_ref_clk, 0);
    
    fast_spi_slave_reg_handle_t spi_slave_handler;
    uint8_t __attribute__((aligned (4))) reg_map[640];

    PAR_JOBS(
        PJOB(spi_master_task, (&spi_ctx, &spi_dev)),
        PJOB(fast_spi_slave_reg, (&spi_slave_handler, p_s_sclk, p_s_mosi, p_s_miso, p_s_ss, clk1, reg_map, 640, 0, 0, NUM_NOP, 0))
    );
}

void main_tile1(chanend_t c_tile0, unsigned tile0_id)
{
    // Do nothing here
}