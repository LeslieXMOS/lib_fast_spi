#include <stdio.h>
#include <string.h>
#include <xs1.h>
#include <platform.h>
#include <xcore/parallel.h>
#include <xcore/select.h>
#include <xcore/channel.h>
#include <xcore/port.h>
#include <xcore/clock.h>
#include <xcore/triggerable.h>
#include <xcore/interrupt_wrappers.h>
#include <xcore/interrupt.h>
#include <xclib.h>
#include "power.h"
#include "spi_new.h"
#include "spi.h"

DECLARE_JOB(dummy_task, (void));
void dummy_task(void) {
    volatile unsigned i = 0;
    while (1) {
        i += 10;
        i -= 19;
    }
}

DECLARE_JOB(pll_handler, (port_t, port_t));
void pll_handler(port_t p_button, port_t p_check) {
    port_enable(p_button);
    port_enable(p_check);
    port_out(p_check, 0);

    int button_state;
    button_state = port_in(p_button);
    port_set_trigger_in_not_equal(p_button, button_state);

    SELECT_RES(
        CASE_THEN(p_button, button_handler),
        DEFAULT_THEN(default_handler)) {
            button_handler: {
                button_state = port_in(p_button);
                port_set_trigger_in_not_equal(p_button, button_state);
                if (button_state & (1 << 5)) {      //L71 board:  Buttons A bit5
                    port_out(p_check, (1 << 2));    //L71 board:  LEDR  bit2
                    pll_bypass_on();
                    port_out(p_check, 0);
                } else {
                    port_out(p_check, (1 << 2));
                    pll_bypass_off();
                    port_out(p_check, 0);                    
                }
                continue;
            }
            default_handler: {
                continue;
            }
        }
}

void check_data_same(uint8_t* a, uint8_t* b, size_t len, int div) {
    for (int i = 0; i < len; ++i) {
        if (a[i] != b[i]) {
            // printf("%d: %x %x, %d %d\n", i, a[i], b[i], len, div);
        }
    }
}

DECLARE_JOB(read_sensor_task, (spi_master_handle_t*, spi_master_device_handle_t*));
void read_sensor_task(spi_master_handle_t* spi_ctx, spi_master_device_handle_t* spi_master_dev) {
    uint8_t __attribute__((aligned (4))) tx_buf[640] = {
        0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
        0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
        0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
        0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
        0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
        0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
        0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
        0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
        0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
        0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
        0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
        0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
        0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
        0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
        0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
        0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
        0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
        0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
        0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
        0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
        0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
        0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
        0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
        0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
        0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
        0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
        0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
        0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
        0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
        0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
        0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
        0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
        0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
        0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
        0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
        0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
        0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
        0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
        0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
        0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
        0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
        0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
        0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
        0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
        0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
        0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
        0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
        0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
        0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
        0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
        0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
        0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
        0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
        0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
        0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
        0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
        0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
        0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
        0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
        0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
        0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
        0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
        0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
        0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
        0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
        0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
        0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
        0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
        0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
        0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
        0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
        0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
        0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
        0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
        0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
        0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
        0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
        0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
        0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
        0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D
    };
    uint8_t __attribute__((aligned (4))) rx_buf[640] = {0x0};
    // spi_master_dev->clk_divider = 1;
    // spi_master_dev->input_delay = 34;
    // spi_master_dev->input_delay_1B = 18;
    // new_spi_master_set_clk_div(spi_master_dev, 1);
    // local_thread_mode_set_bits(thread_mode_fast | thread_mode_high_priority);
    local_thread_mode_set_bits(thread_mode_high_priority);
    while (1) {
        for (int j = 2; j < 50; ++j) {
            new_spi_master_set_clk_div(spi_master_dev, j);
            new_spi_master_init_xfer(spi_master_dev);
            for (int i = 1; i <= 640; ++i) {
                memset(rx_buf, 0, sizeof(rx_buf));
                new_spi_master_xfer(spi_master_dev, tx_buf, rx_buf, i);
                check_data_same(rx_buf, tx_buf, i, j);
            }
        }
        printf("d\n");
        // printf("%x %x %x %x\n", rx_buf[0], rx_buf[1], rx_buf[2], rx_buf[3]);
    }
}

// DECLARE_JOB(read_sensor_task, (spi_master_t*, spi_master_device_t*));
// void read_sensor_task(spi_master_t* spi_ctx, spi_master_device_t* spi_master_dev) {
//     uint8_t read_reg_tx_buf[640] = {
//         0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
//         0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
//         0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
//         0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
//         0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
//         0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
//         0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
//         0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
//         0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
//         0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
//         0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
//         0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
//         0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
//         0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
//         0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
//         0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
//         0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
//         0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
//         0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
//         0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
//         0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
//         0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
//         0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
//         0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
//         0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
//         0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
//         0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
//         0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
//         0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
//         0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
//         0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
//         0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
//         0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
//         0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
//         0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
//         0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
//         0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
//         0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
//         0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
//         0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
//         0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
//         0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
//         0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
//         0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
//         0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
//         0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
//         0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
//         0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
//         0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
//         0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
//         0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
//         0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
//         0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
//         0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
//         0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
//         0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
//         0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
//         0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
//         0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
//         0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
//         0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
//         0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
//         0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
//         0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D,
//         0x79, 0x32, 0x02, 0x45, 0xEC, 0x66, 0x60, 0x69, 
//         0xE3, 0x26, 0x85, 0xCC, 0xEC, 0x7F, 0x41, 0xFA, 
//         0x07, 0x73, 0x05, 0x74, 0xC8, 0x04, 0xE6, 0x53, 
//         0xD5, 0x76, 0xCF, 0x2E, 0x08, 0xBF, 0xAC, 0x81, 
//         0xF2, 0xAF, 0xC7, 0xDE, 0x15, 0x27, 0x47, 0xF8, 
//         0x4E, 0xCC, 0xC4, 0x3A, 0x4B, 0x05, 0x34, 0x52, 
//         0x79, 0x39, 0xC6, 0x41, 0x3D, 0xAD, 0x94, 0x12, 
//         0x23, 0x64, 0x41, 0x2C, 0x23, 0xED, 0xAD, 0x15, 
//         0x9C, 0x74, 0xF4, 0xB1, 0x9C, 0x3B, 0xA9, 0xEA, 
//         0x08, 0x6D, 0x24, 0x53, 0x73, 0x59, 0xA6, 0xEC, 
//         0x92, 0x6C, 0x2D, 0xD0, 0x19, 0xC2, 0xE2, 0x3D, 
//         0x26, 0x23, 0x69, 0x49, 0x11, 0x16, 0x5F, 0xAD, 
//         0x8B, 0x53, 0x5F, 0x27, 0x8E, 0x08, 0x11, 0x96, 
//         0x76, 0x35, 0xEA, 0xE9, 0x8E, 0x90, 0xD5, 0x21, 
//         0xFC, 0x02, 0xF1, 0x16, 0xC4, 0xD3, 0x53, 0xEA, 
//         0xF7, 0xBC, 0x34, 0x08, 0xD2, 0x93, 0xB5, 0x5D
//     };
//     uint8_t read_reg_rx_buf[640];
//     while (1) {
//         spi_master_start_transaction(spi_master_dev);
//         for (int i = 1; i <= 640; ++i) {
//             memset(read_reg_rx_buf, 0, sizeof(read_reg_rx_buf));
//             spi_master_transfer(spi_master_dev, read_reg_tx_buf, read_reg_rx_buf, i);
//             check_data_same(read_reg_rx_buf, read_reg_tx_buf, i);
//         }
//         spi_master_end_transaction(spi_master_dev);
//     }
// }

uint8_t spi_slave_tx_buf[16] = {0x12, 0x34, 0x56, 0x78, 0x9A, 0xBC, 0xDE, 0xFF};
uint8_t spi_slave_rx_buf[16];
uint8_t spi_slave_reg[10] = {0};

SPI_CALLBACK_ATTR
void spi_slave_transaction_started(void *app_data, uint8_t **out_buf, size_t *outbuf_len, uint8_t **in_buf, size_t *inbuf_len) {
    *out_buf = spi_slave_tx_buf;
    *in_buf = spi_slave_rx_buf;
    *outbuf_len = 16;
    *inbuf_len = 16;
}

SPI_CALLBACK_ATTR
void spi_slave_transaction_ended(void *app_data, uint8_t **out_buf, size_t bytes_written, uint8_t **in_buf, size_t bytes_read, size_t read_bits) {
}

// DEFINE_INTERRUPT_PERMITTED(spi_isr_grp, void, spi_slave_task, void* app_data)
// {
//     // spi slave
//     port_t p_s_sclk  = PORT_SQI_CS_0;   // QSPI CS_N
//     port_t p_s_ss    = PORT_SSB;        // SPI_CS_N
//     port_t p_s_miso  = PORT_I2C_SDA;    // SDA
//     port_t p_s_mosi  = PORT_I2C_SCL;    // SCL
//     xclock_t clk1    = XS1_CLKBLK_2;

//     spi_slave_callback_group_t spi_cbg = {
//         .slave_transaction_started = (slave_transaction_started_t) spi_slave_transaction_started,
//         .slave_transaction_ended = (slave_transaction_ended_t) spi_slave_transaction_ended,
//         .app_data = app_data
//     };
//     spi_slave(&spi_cbg, p_s_sclk, p_s_mosi, p_s_miso, p_s_ss, clk1, SPI_MODE_0, 0);
// }

// DECLARE_JOB(spi_slave_task_wrapper, (void));
// void spi_slave_task_wrapper(void) {
//     PAR_JOBS(
//         PJOB(INTERRUPT_PERMITTED(spi_slave_task), (NULL))
//     );
// }

void main_tile0(chanend_t c_tile1, unsigned tile1_id)
{
#ifdef PLL_BYPASS_ON
    // button
    port_t p_buttons = XS1_PORT_8D;     //L71 board:  Buttons A     bit5
    // led
    port_t p_leds    = XS1_PORT_4F;     //L71 board:  LEDR          bit2
#endif
#ifdef SPI_TASK
    // spi master
    port_t p_m_sclk  = PORT_SQI_SCLK_0; // SPI CLK
    port_t p_m_cs    = XS1_PORT_4B;     // QSPI_D0
    port_t p_m_miso  = PORT_SPI_MISO;   // MISO
    port_t p_m_mosi  = PORT_SPI_MOSI;   // MOSI
    // clock block
    xclock_t clk0    = XS1_CLKBLK_1;

    port_t p_s_sclk  = PORT_SQI_CS_0;   // QSPI CS_N
    port_t p_s_ss    = PORT_SSB;        // SPI_CS_N
    port_t p_s_miso  = PORT_I2C_SDA;    // SDA
    port_t p_s_mosi  = PORT_I2C_SCL;    // SCL
    xclock_t clk1    = XS1_CLKBLK_2;
    spi_slave_handle_t spi_slave_handle;
#elif defined(OUT_REF_CLK)
    port_t p_ref     = PORT_SQI_SCLK_0; // SPI CLK
    xclock_t clk_ref = XS1_CLKBLK_1;
    port_enable(p_ref);
    clock_enable(clk_ref);
    clock_set_divide(clk_ref, 5);
    port_set_clock(p_ref, clk_ref);
    port_set_out_clock(p_ref);
    clock_start(clk_ref);
#endif

#ifndef XSIM_ON
    enable_core_divider();
#endif
#ifdef TILE1_OFF
    switch_power_down();
    disable_core_clock(tile1_id);
#endif
#ifdef TILE_CLK_DIV
    set_core_clock_divider(get_local_tile_id(), TILE_CLK_DIV);
#endif
#ifdef PLL_BYPASS_ON
    delay_milliseconds(10);
    pll_bypass_on();
#endif

#ifdef SPI_TASK
    spi_master_handle_t spi_ctx;
    spi_master_device_handle_t spi_dev;
    new_spi_master_init(&spi_ctx, p_m_sclk, p_m_miso, p_m_mosi, p_m_cs, clk0, true);
    new_spi_master_device_init(&spi_ctx, &spi_dev, 0, 0, 0, spi_clock_source_ref_clk, 0);
    // spi_master_t spi_ctx;
    // spi_master_device_t spi_dev;

    // spi_master_init(&spi_ctx, clk0, p_m_cs, p_m_sclk, p_m_mosi, p_m_miso);
    // spi_master_device_init(&spi_dev, &spi_ctx, 0, SPI_MODE_0, spi_master_source_clock_ref, 10, spi_master_sample_delay_0, 0, 0, 0, 0);
#endif

    PAR_JOBS(
#ifdef PLL_BYPASS_ON
        PJOB(pll_handler, (p_buttons, p_leds)),
#endif
#if defined(SPI_TASK)
        // PJOB(spi_master_new, (c_tile1, p_m_sclk, p_m_miso, p_m_mosi, p_m_cs, clk0)),
        PJOB(dummy_task, ()),
        PJOB(dummy_task, ()),
        PJOB(dummy_task, ()),
        PJOB(dummy_task, ()),
        PJOB(dummy_task, ()),
        PJOB(read_sensor_task, (&spi_ctx, &spi_dev)),
        PJOB(new_spi_slave, (&spi_slave_handle, p_s_sclk, p_s_mosi, p_s_miso, p_s_ss, clk1, 0, 0))
#elif defined(DUMMY_TASK)
#if DUMMY_TASK > 4
        PJOB(dummy_task, ()),
#endif
#if DUMMY_TASK > 3
        PJOB(dummy_task, ()),
#endif
#if DUMMY_TASK > 2
        PJOB(dummy_task, ()),
#endif
#if DUMMY_TASK > 1
        PJOB(dummy_task, ()),
#endif
        PJOB(dummy_task, ())
#endif
    );
}

void main_tile1(chanend_t c_tile0, unsigned tile0_id)
{
#ifndef XSIM_ON
    enable_core_divider();
#endif
    // Do nothing here
}